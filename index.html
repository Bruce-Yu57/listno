<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>等差數列大挑戰 - 8年級數學</title>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4; /* Green-50 */
        }
        
        /* Custom Input Styling */
        .math-input {
            transition: all 0.2s;
            border-bottom: 3px solid #cbd5e1;
        }
        .math-input:focus {
            outline: none;
            border-bottom-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        /* Fraction Styling */
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 0.9em;
        }
        .fraction-top {
            border-bottom: 1px solid currentColor;
            display: block;
            line-height: 1.2;
            padding: 0 2px;
        }
        .fraction-bottom {
            display: block;
            line-height: 1.2;
            padding: 0 2px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Helper: GCD for simplifying fractions
        const gcd = (a, b) => {
            return b === 0 ? a : gcd(b, a % b);
        };

        // Helper: Simplify fraction object {n, d}
        const simplifyFraction = (n, d) => {
            if (d < 0) { n = -n; d = -d; }
            const common = gcd(Math.abs(n), Math.abs(d));
            return { n: n / common, d: d / common };
        };

        // Helper: Convert number or fraction object to string for display
        const formatValue = (val) => {
            if (typeof val === 'number') return val.toString();
            // It's a fraction object
            const simple = simplifyFraction(val.n, val.d);
            if (simple.d === 1) return simple.n.toString();
            return `${simple.n}/${simple.d}`; // We will render this nicely in UI
        };

        // Helper: Parse user input (supports "3/2", "-1.5", "5")
        const parseInput = (input) => {
            const cleanInput = input.trim();
            if (!cleanInput) return NaN;

            if (cleanInput.includes('/')) {
                const parts = cleanInput.split('/');
                if (parts.length !== 2) return NaN;
                const n = parseFloat(parts[0]);
                const d = parseFloat(parts[1]);
                if (isNaN(n) || isNaN(d) || d === 0) return NaN;
                return n / d;
            }
            return parseFloat(cleanInput);
        };

        // Helper: Check if two values are equal (with tolerance for floats)
        const isValueEqual = (v1, v2) => {
            let val1 = typeof v1 === 'object' ? v1.n / v1.d : v1;
            let val2 = typeof v2 === 'object' ? v2.n / v2.d : v2;
            return Math.abs(val1 - val2) < 0.0001;
        };

        const App = () => {
            const [level, setLevel] = useState(1); // 1: Integer, 2: Fraction
            const [sequence, setSequence] = useState([]);
            const [blanks, setBlanks] = useState({}); // { index: userAnswer }
            const [hiddenIndices, setHiddenIndices] = useState([]);
            const [feedback, setFeedback] = useState(null); // { type: 'success' | 'error', msg: '' }
            const [correctCount, setCorrectCount] = useState(0);
            const [totalPlayed, setTotalPlayed] = useState(0);
            const [attempts, setAttempts] = useState(0);
            const [showConfetti, setShowConfetti] = useState(false);
            const inputRefs = useRef([]);

            // Generate a new problem
            const generateProblem = () => {
                setFeedback(null);
                setBlanks({});
                setAttempts(0);
                setShowConfetti(false);
                
                // Difficulty Logic based on Level
                const isFraction = level === 2;
                const length = 5; // Fixed length for consistency
                let newSequence = [];
                let d, start;

                if (isFraction) {
                    // Fraction Logic (Level 2)
                    const denominators = [2, 3, 4, 5];
                    const baseD = denominators[Math.floor(Math.random() * denominators.length)];
                    
                    // Numerators (allow negative start)
                    const startNum = Math.floor(Math.random() * 20) - 10; 
                    const diffNum = (Math.floor(Math.random() * 5) + 1); // 確保公差為正，數列由小到大
                    
                    start = { n: startNum, d: baseD };
                    d = { n: diffNum, d: baseD };

                    for (let i = 0; i < length; i++) {
                        newSequence.push({
                            n: startNum + (i * diffNum),
                            d: baseD
                        });
                    }
                } else {
                    // Integer Logic (Level 1)
                    start = Math.floor(Math.random() * 60) - 30; // -30 to 30
                    d = Math.floor(Math.random() * 15) + 1; // 1 to 15 (確保為正)
                    
                    for (let i = 0; i < length; i++) {
                        newSequence.push(start + (i * d));
                    }
                }

                // Determine blanks (1 or 2 blanks)
                const numBlanks = Math.random() < 0.6 ? 1 : 2;
                const indices = [];
                while (indices.length < numBlanks) {
                    const idx = Math.floor(Math.random() * length);
                    if (!indices.includes(idx)) indices.push(idx);
                }
                
                // Sort indices so tabbing order is natural
                indices.sort((a, b) => a - b);

                setSequence(newSequence);
                setHiddenIndices(indices);
            };

            // Trigger generation when level changes or on mount
            useEffect(() => {
                generateProblem();
            }, [level]);

            // Handle Input Change
            const handleInputChange = (idx, value) => {
                setBlanks(prev => ({ ...prev, [idx]: value }));
                setFeedback(null); // Clear feedback when typing
            };

            // Check Answer
            const checkAnswer = () => {
                let allCorrect = true;
                
                // Verify all blanks are filled
                if (Object.keys(blanks).length < hiddenIndices.length) {
                    setFeedback({ type: 'warning', msg: '請填寫所有空格喔！' });
                    return;
                }

                hiddenIndices.forEach(idx => {
                    const userVal = parseInput(blanks[idx]);
                    const correctVal = sequence[idx];
                    
                    if (isNaN(userVal) || !isValueEqual(userVal, correctVal)) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    setFeedback({ type: 'success', msg: '答對了！太棒了！' });
                    setShowConfetti(true);
                    if (attempts === 0) {
                        setCorrectCount(prev => prev + 1);
                    }
                    setTotalPlayed(prev => prev + 1);
                } else {
                    setFeedback({ type: 'error', msg: '哎呀，再算算看！' });
                    setAttempts(prev => prev + 1);
                }
            };

            // Hint logic (calculating d)
            const getHint = () => {
                let dVal;
                let val1 = sequence[0];
                let val2 = sequence[1];
                
                let v1 = typeof val1 === 'object' ? val1.n/val1.d : val1;
                let v2 = typeof val2 === 'object' ? val2.n/val2.d : val2;
                let diff = v2 - v1;
                
                // Format hint diff
                let hintText = "";
                if (Number.isInteger(diff)) {
                    hintText = diff.toString();
                } else {
                    // Try to show as fraction roughly
                    hintText = diff.toFixed(2).replace(/\.00$/, ''); 
                    // Better: Reconstruct fraction string if it was fraction mode
                    if(typeof val1 === 'object') {
                         const simple = simplifyFraction(val2.n * val1.d - val1.n * val2.d, val1.d * val2.d);
                         hintText = `${simple.n}/${simple.d}`;
                    }
                }
                
                return `提示：這題的公差 (d) 是 ${hintText}`;
            };

            // Render a single term (number or input)
            const renderTerm = (term, index) => {
                const isHidden = hiddenIndices.includes(index);
                const isFraction = typeof term === 'object';
                
                if (isHidden) {
                    const isSuccess = feedback?.type === 'success';
                    return (
                        <input
                            key={index}
                            type="text"
                            inputMode="decimal"
                            value={blanks[index] || ''}
                            onChange={(e) => handleInputChange(index, e.target.value)}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') checkAnswer();
                            }}
                            disabled={isSuccess}
                            placeholder="?"
                            className={`math-input w-20 md:w-24 text-center text-xl md:text-2xl font-bold p-2 mx-1 md:mx-2 rounded bg-white 
                                ${feedback?.type === 'error' ? 'border-red-400 text-red-600' : ''}
                                ${isSuccess ? 'border-green-500 text-green-600 bg-green-50' : 'border-gray-300 text-gray-800'}
                            `}
                        />
                    );
                }

                // Render number display
                if (isFraction) {
                    const simple = simplifyFraction(term.n, term.d);
                    if (simple.d === 1) {
                         return <span key={index} className="text-2xl md:text-3xl font-bold text-gray-700 mx-2 md:mx-4">{simple.n}</span>;
                    }
                    return (
                        <span key={index} className="fraction mx-2 md:mx-4 font-bold text-gray-700 text-xl md:text-2xl">
                            <span className="fraction-top">{simple.n}</span>
                            <span className="fraction-bottom">{simple.d}</span>
                        </span>
                    );
                }

                return (
                    <span key={index} className="text-2xl md:text-3xl font-bold text-gray-700 mx-2 md:mx-4">
                        {term}
                    </span>
                );
            };

            const resetStats = () => {
                if(confirm("確定要清除所有紀錄並重新開始嗎？")) {
                    setCorrectCount(0);
                    setTotalPlayed(0);
                    generateProblem();
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center py-8 px-4">
                    {/* Header */}
                    <header className="mb-6 text-center">
                        <div className="flex items-center justify-center gap-3 mb-2">
                             <i className="fa-solid fa-calculator text-3xl text-emerald-600"></i>
                            <h1 className="text-3xl font-bold text-gray-800">等差數列大挑戰</h1>
                        </div>
                        <p className="text-gray-600">八年級數學練習 | 填入缺少的數字</p>
                    </header>

                    {/* Level Selector */}
                    <div className="flex justify-center gap-4 mb-6">
                        <button 
                            onClick={() => setLevel(1)}
                            className={`px-6 py-2 rounded-full font-bold transition-all border-2 
                                ${level === 1 
                                    ? 'bg-emerald-500 border-emerald-500 text-white shadow-lg scale-105' 
                                    : 'bg-white border-gray-200 text-gray-500 hover:border-emerald-300 hover:text-emerald-500'}`}
                        >
                            Level 1: 整數挑戰
                        </button>
                        <button 
                            onClick={() => setLevel(2)}
                            className={`px-6 py-2 rounded-full font-bold transition-all border-2
                                ${level === 2 
                                    ? 'bg-purple-500 border-purple-500 text-white shadow-lg scale-105' 
                                    : 'bg-white border-gray-200 text-gray-500 hover:border-purple-300 hover:text-purple-500'}`}
                        >
                            Level 2: 分數挑戰
                        </button>
                    </div>

                    {/* Stats Card */}
                    <div className="w-full max-w-2xl bg-white rounded-xl shadow-md p-4 mb-6 flex justify-around items-center border-l-4 border-emerald-500">
                        <div className="text-center">
                            <p className="text-sm text-gray-500">第一次答對</p>
                            <p className="text-2xl font-bold text-emerald-600">{correctCount} <span className="text-sm text-gray-400 font-normal">題</span></p>
                        </div>
                        <div className="h-8 w-px bg-gray-200"></div>
                         <div className="text-center">
                            <p className="text-sm text-gray-500">總答對率</p>
                            <p className="text-2xl font-bold text-blue-600">
                                {totalPlayed > 0 ? Math.round((correctCount/totalPlayed)*100) : 0}%
                            </p>
                        </div>
                         <div className="h-8 w-px bg-gray-200"></div>
                        <button 
                            onClick={resetStats}
                            className="text-gray-400 hover:text-red-500 transition-colors"
                            title="重新開始"
                        >
                            <i className="fa-solid fa-rotate-right text-lg"></i>
                        </button>
                    </div>

                    {/* Game Area */}
                    <div className="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">
                        
                        {/* Question Number Badge */}
                        <div className="absolute top-0 left-0 bg-blue-100 text-blue-800 px-4 py-1 rounded-br-xl font-medium text-sm">
                            第 {totalPlayed + 1} 題
                        </div>

                        {/* Hint Button (Appears after 2 failed attempts) */}
                        {attempts >= 2 && feedback?.type !== 'success' && (
                             <div className="absolute top-4 right-4 animate-bounce">
                                <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded border border-yellow-200">
                                    {getHint()}
                                </span>
                            </div>
                        )}

                        <div className="mt-8 mb-12 flex flex-wrap justify-center items-center gap-y-4">
                            {sequence.map((term, index) => (
                                <React.Fragment key={index}>
                                    {renderTerm(term, index)}
                                    {index < sequence.length - 1 && (
                                        <span className="text-gray-300 font-bold text-xl">,</span>
                                    )}
                                </React.Fragment>
                            ))}
                        </div>

                        {/* Feedback Message */}
                        <div className="h-8 text-center mb-6">
                            {feedback && (
                                <div className={`text-lg font-bold flex items-center justify-center gap-2 fade-in
                                    ${feedback.type === 'success' ? 'text-emerald-600' : 
                                      feedback.type === 'error' ? 'text-rose-500' : 'text-amber-500'}`}>
                                    {feedback.type === 'success' && <i className="fa-solid fa-circle-check"></i>}
                                    {feedback.type === 'error' && <i className="fa-solid fa-circle-xmark"></i>}
                                    {feedback.type === 'warning' && <i className="fa-solid fa-circle-exclamation"></i>}
                                    {feedback.msg}
                                </div>
                            )}
                        </div>

                        {/* Controls */}
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            {feedback?.type !== 'success' ? (
                                <button
                                    onClick={checkAnswer}
                                    className="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-lg transform active:scale-95 transition-all"
                                >
                                    檢查答案
                                </button>
                            ) : (
                                <button
                                    onClick={generateProblem}
                                    className="w-full sm:w-auto bg-emerald-500 hover:bg-emerald-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2"
                                >
                                    下一題 <i className="fa-solid fa-arrow-right"></i>
                                </button>
                            )}
                        </div>
                        
                        {/* Help Text */}
                        <div className="mt-6 text-center text-sm text-gray-400">
                            <i className="fa-regular fa-lightbulb mr-1"></i>
                            {level === 2 ? '如果是分數，請輸入如 3/2 或 -1/2。小數也可以喔！' : '請輸入整數答案。'}
                        </div>
                    </div>

                    {/* Visual Decor - Notebook style */}
                    <div className="mt-8 text-center text-gray-400 text-sm">
                        &copy; 8年級數學輔助工具
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>